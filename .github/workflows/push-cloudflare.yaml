name: Build

on:
    push:
        branches: [main, uat, release*]
    pull_request_target:
        branches: [main, uat, release*]
    workflow_dispatch:

jobs:
    build:
        name: Run production build
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v4

            # selecting a toolchain either by action or manual `rustup` calls should happen
            # before the plugin, as the cache uses the current rustc version as its cache key
            - run: rustup toolchain install stable --profile minimal
            - name: Cache Cargo registry and build artifacts
              uses: actions/cache@v4
              with:
                path: |
                  target
                  ~/.cargo/bin
                  ~/.cargo/registry
                  ~/.cargo/git
                # Use Cargo.toml hash so cache updates when dependencies change
                key: cargo-cache-${{ runner.os }}-${{ hashFiles('**/Cargo.toml') }}
                restore-keys: |
                  cargo-cache-${{ runner.os }}-

            - name: Cache build output
              uses: actions/cache@v4
              with:
                path: |
                  build
                key: build-cache-${{ runner.os }}-${{ hashFiles('**/Cargo.toml') }}
                restore-keys: |
                  build-cache-${{ runner.os }}-
            - run: rustup target add wasm32-unknown-unknown
            - name: Install lld
              run: sudo apt install -y lld clang gcc llvm

            - name: Replace D1_DATABASE_ID in wrangler.jsonc
              run: sed -i "s/\${D1_DATABASE_ID}/${{ secrets.D1_DATABASE_ID }}/g" wrangler.jsonc

            - name: Build Rust Worker (produce build/index.js)
              run: |
                # 确保 worker-build 已安装（此前步骤已安装，但保持幂等）
                if ! command -v worker-build &> /dev/null; then
                  cargo install worker-build
                fi
                # 构建输出到 build/，与 wrangler.jsonc 中的 main 路径保持一致
                worker-build --release
                echo "--- build directory listing ---"
                ls -la build || true

            - uses: cloudflare/wrangler-action@v3
              id: cf
              env:
                  D1_DATABASE_ID: ${{ secrets.D1_DATABASE_ID }}
              with:
                  apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
                  accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
